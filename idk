--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

--// GUI Main
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "UniversalMenu"
ScreenGui.Parent = player:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false

-- Open/Close Button
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 40, 0, 40)
ToggleButton.Position = UDim2.new(0, 10, 0.5, -20)
ToggleButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
ToggleButton.Text = "â‰¡"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Parent = ScreenGui

-- Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 500, 0, 350)
MainFrame.Position = UDim2.new(0.5, -250, 0.5, -175)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.Visible = true
MainFrame.Parent = ScreenGui

-- Tabs Holder
local TabBar = Instance.new("Frame")
TabBar.Size = UDim2.new(1, 0, 0, 40)
TabBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
TabBar.Parent = MainFrame

-- Pages Container
local Pages = Instance.new("Frame")
Pages.Size = UDim2.new(1, 0, 1, -40)
Pages.Position = UDim2.new(0, 0, 0, 40)
Pages.BackgroundTransparency = 1
Pages.Parent = MainFrame

-- Tab Manager
local tabs = {}
local function createTab(name)
    local tabButton = Instance.new("TextButton")
    tabButton.Size = UDim2.new(0, 100, 1, 0)
    tabButton.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    tabButton.Text = name
    tabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tabButton.Parent = TabBar
    
    local page = Instance.new("ScrollingFrame")
    page.Size = UDim2.new(1, 0, 1, 0)
    page.CanvasSize = UDim2.new(0, 0, 0, 0)
    page.ScrollBarThickness = 4
    page.Visible = false
    page.Parent = Pages
    
    tabButton.MouseButton1Click:Connect(function()
        for _, t in pairs(tabs) do
            t.page.Visible = false
            t.button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        end
        page.Visible = true
        tabButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    end)
    
    table.insert(tabs, {button = tabButton, page = page})
    if #tabs == 1 then
        page.Visible = true
        tabButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    end
    tabButton.Position = UDim2.new(0, (#tabs - 1) * 100, 0, 0)
    return page
end

--// Tabs
local visualTab = createTab("Visuals")
local miscTab = createTab("Misc")
local settingsTab = createTab("Settings")

--// ESP
local espEnabled = false
local espObjects = {}

local function createESP(plr)
    if plr == player then return end
    if espObjects[plr] then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(0, 100, 0, 40)
    billboard.AlwaysOnTop = true
    billboard.Name = "ESPTag"
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 1, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = plr.Name
    nameLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextScaled = true
    nameLabel.Parent = billboard
    
    espObjects[plr] = billboard
    
    if plr.Character and plr.Character:FindFirstChild("Head") then
        billboard.Parent = plr.Character.Head
    end
    
    plr.CharacterAdded:Connect(function(char)
        local head = char:WaitForChild("Head", 5)
        if head then
            billboard.Parent = head
        end
    end)
end

local function refreshESP()
    if not espEnabled then
        for _, tag in pairs(espObjects) do
            tag:Destroy()
        end
        espObjects = {}
        return
    end
    for _, plr in pairs(Players:GetPlayers()) do
        createESP(plr)
    end
end

-- auto refresh ESP every second
RunService.Heartbeat:Connect(function()
    if espEnabled then
        refreshESP()
    end
end)

-- ESP Toggle Button
local espButton = Instance.new("TextButton")
espButton.Size = UDim2.new(0, 200, 0, 40)
espButton.Position = UDim2.new(0, 10, 0, 10)
espButton.Text = "Toggle ESP"
espButton.Parent = visualTab
espButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    refreshESP()
end)

--// Lock On
local lockOn = false
local lockTarget = nil

local function getClosestPlayer()
    local closest, distance = nil, math.huge
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local mag = (plr.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
            if mag < distance then
                closest = plr
                distance = mag
            end
        end
    end
    return closest
end

local lockButton = Instance.new("TextButton")
lockButton.Size = UDim2.new(0, 200, 0, 40)
lockButton.Position = UDim2.new(0, 10, 0, 60)
lockButton.Text = "Lock On"
lockButton.Parent = miscTab
lockButton.MouseButton1Click:Connect(function()
    lockOn = not lockOn
    if lockOn then
        lockButton.Text = "Unlock"
    else
        lockButton.Text = "Lock On"
        camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
    end
end)

RunService.RenderStepped:Connect(function()
    if lockOn then
        lockTarget = getClosestPlayer()
        if lockTarget and lockTarget.Character and lockTarget.Character:FindFirstChild("HumanoidRootPart") then
            camera.CFrame = CFrame.new(camera.CFrame.Position, lockTarget.Character.HumanoidRootPart.Position)
            camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
        end
    end
end)

--// Settings Tab
local rainbow = false
local function applyRainbow()
    spawn(function()
        while rainbow do
            for i = 0, 1, 0.01 do
                MainFrame.BackgroundColor3 = Color3.fromHSV(i, 1, 1)
                RunService.RenderStepped:Wait()
            end
        end
    end)
end

local rainbowButton = Instance.new("TextButton")
rainbowButton.Size = UDim2.new(0, 200, 0, 40)
rainbowButton.Position = UDim2.new(0, 10, 0, 10)
rainbowButton.Text = "Rainbow BG"
rainbowButton.Parent = settingsTab
rainbowButton.MouseButton1Click:Connect(function()
    rainbow = not rainbow
    if rainbow then
        applyRainbow()
    else
        MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    end
end)

-- Toggle menu visibility
local open = true
ToggleButton.MouseButton1Click:Connect(function()
    open = not open
    MainFrame.Visible = open
end)
